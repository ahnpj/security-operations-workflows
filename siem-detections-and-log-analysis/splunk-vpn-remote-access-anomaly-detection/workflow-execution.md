# Workflow Execution — VPN Authentication and Remote Access Anomaly Analysis Using Splunk

## Overview
This workflow execution demonstrates how VPN authentication and session telemetry can be analyzed in Splunk to identify anomalous remote access behavior, including unusual geolocation patterns, repeated authentication failures, and abnormal session termination activity. The workflow focuses on transforming raw JSON-formatted VPN logs into structured, queryable data that supports rapid triage and baseline development in a SOC context.

> **Workflow vs Execution vs Writeup (Terminology Used Here)**  
> - **Workflows** refer to operational tasks such as onboarding telemetry and validating parsing behavior.  
> - **Executions** refer to hands-on configuration and validation using real data and Splunk services.  
> - **Writeups** document configuration decisions, troubleshooting steps, and validation results.

---

### Analyst Intent & Operational Focus
The primary intent is to evaluate how effectively Splunk can surface indicators of suspicious VPN activity when logs are properly parsed and aggregated. Rather than focusing on alert-driven detection, this workflow emphasizes analyst-led exploratory analysis, where patterns such as repeated failures, geographic anomalies, and unusual session outcomes are identified through structured search queries and aggregation.

This approach mirrors real SOC workflows in which analysts begin with high-level volume and distribution analysis before pivoting into more targeted investigations. The queries demonstrated here can be operationalized into dashboards, alerts, or scheduled searches once baseline behavior is established.

### Workflow Scope and Objectives
This workflow is scoped to authentication and session-level telemetry generated by VPN infrastructure. The objective is not to perform attribution or endpoint validation, but to determine whether access patterns themselves indicate potential misuse, compromised credentials, or unstable connections requiring further investigation.

Key objectives include:
- Establishing baseline activity by user, geography, and session outcome
- Identifying accounts with repeated authentication failures
- Highlighting source IP addresses associated with frequent session teardowns
- Demonstrating how JSON fields are extracted and aggregated using SPL

## Environment and Execution Context
All analysis was performed within a controlled training environment using simulated VPN log data designed to reflect common remote access telemetry collected by security teams. Events were ingested into Splunk under a single logical index and stored in JSON format, requiring explicit field extraction prior to aggregation.

### Data Sources Analyzed
- VPN authentication and session events
- Fields of interest included:
  - `UserName`
  - `Source_ip`
  - `Source_Country`
  - `source_state`
  - `protocol`
  - `port` / `dest_port`
  - `action`

### Tools and Platforms
- Splunk Enterprise
- SPL (Search Processing Language)
- JSON field extraction using `spath`

### Workflow Map (High-Level)
1. Validate that VPN events are searchable and fields are extractable from JSON
2. Aggregate events by geography and user to establish access baselines
3. Isolate failed authentication attempts and identify potential brute-force patterns
4. Analyze session termination behavior over secure transport protocols
5. Review session outcome distributions to identify abnormal trends

---

## Step-by-Step Execution

### Phase 1 — Validate JSON Field Extraction and Dataset Scope

**Objective:** Ensure VPN logs are accessible and structured fields can be queried.

**Step 1:** Run a broad search against the dataset to confirm events are indexed.
```spl
index="main"
```

**Step 2:** Apply `spath` to extract JSON fields for use in subsequent aggregations.
```spl
index="main"
| spath
```

This confirms that nested fields such as `UserName`, `Source_Country`, and `action` are available for aggregation and filtering.

---

### Phase 2 — Analyze Activity by User and Country

**Objective:** Identify accounts generating VPN sessions across multiple geographic regions.

Events grouped by `UserName` and `Source_Country`, showing the number of times a user generated traffic from different countries:  

```spl
index="main" 
| spath 
| search Source_Country!="France" 
| stats count by UserName, Source_Country 
| sort - count
```

- `index="main"` → Points Splunk to the correct dataset.  
- `spath` → Ensures JSON fields are parsed for querying.  
- `UserName` → Identifies the account.  
- `Source_Country` → Captures geolocation metadata.  
- `stats count` → Aggregates how many events match.  
- `sort - count` → Displays most frequent results at the top.  

<p align="left">
  <img src="images/lab09-splunk-figure.01.png?raw=true&v=2" 
       alt="SIEM alert" 
       style="border: 2px solid #444; border-radius: 6px;" 
       width="1000"><br>
  <em>Figure 1</em>
</p>

This screenshot shows a Splunk query grouping events by `UserName` and `Source_Country`, excluding traffic from France. The results highlight geolocation activity, allowing detection of unusual login patterns such as a single user appearing in multiple foreign countries. Useful for identifying account compromise or suspicious travel-related anomalies

**Good for:**  

- Detecting unusual geolocation behavior (e.g., a user logging in from multiple foreign countries).  
- Identifying potential account compromise or travel-related anomalies.  


---

### Phase 3 — Identify Failed Authentication Attempts

**Objective:** Surface potential brute-force or credential misuse patterns.

Events where `action=failed`, aggregated by user and IP:

```spl
index="main" action=failed
| spath
| stats count by UserName, Source_ip
| sort - count
```

- `index="main"` → Points Splunk to the correct dataset.  
- `spath` → Ensures JSON fields are parsed for querying.  
- `UserName` → Identifies the account.  
- `action=failed` → Filters only failed authentication attempts. 
- `UserName` → Reveals which account is being targeted.  
- `Source_ip` → Identifies the attacker or misconfigured client.

<p align="left">
  <img src="images/lab09-splunk-figure.02.png?raw=true&v=2" 
       alt="SIEM alert" 
       style="border: 2px solid #444; border-radius: 6px;" 
       width="1000"><br>
  <em>Figure 2</em>
</p>

This screenshot displays a Splunk search filtered for events where `action=failed`. Events are aggregated by `UserName` and `ource_ip`, making it possible to identify repeated login failures tied to specific accounts and source IPs. This is a common use case for detecting brute-force attempts or credential stuffing.

Repeated failures from the same IP against the same account can indicate automated attack attempts or misconfigured clients.

**Good for**  

- Investigating brute force attempts or repeated login failures. 
- Correlating failed attempts with possible attacker IP addresses.  

---

### Phase 4 — Analyze Geographic Distribution Within a Single Country

**Objective:** Establish baseline regional activity patterns.

Events originating only from the `United States`, grouped by `source_state:

```spl
index="main" Source_Country="United States"
| spath
| stats count by source_state
| sort - count
```

- `index="main"` → Points Splunk to the correct dataset.  
- `spath` → Ensures JSON fields are parsed for querying.  
- `Source_Country="United States"` → Filters for U.S. traffic only.  
- `source_state` → Provides geographic detail within the country. 
- `stats count` → Counts activity per state.

<p align="left">
  <img src="images/lab09-splunk-figure.03.png?raw=true&v=2" 
       alt="SIEM alert" 
       style="border: 2px solid #444; border-radius: 6px;" 
       width="1000"><br>
  <em>Figure 3</em>
</p>

This screenshot highlights a Splunk query filtered to `Source_Country="United States"`, with results grouped by `source_state`. The output provides insight into geographic distribution of traffic across U.S. states. This is helpful for baseline monitoring and identifying anomalies (e.g., a user accessing from a state that is outside expected regions).

Unexpected state-level access patterns may indicate account sharing, travel, or compromised VPN credentials.

**Good for**  

- Spotting regional anomalies within the same country.
- Useful for organizations that expect traffic only from certain states.  

---

### Phase 5 — Analyze Secure Session Terminations

**Objective:** Identify IPs frequently terminating encrypted VPN sessions.

Events where action is `teardown`, using `protocol=tcp`, focusing on `port=443` or any destination port equal to 443:


```spl
index="main" action=teardown protocol=tcp (port=443 OR dest_port=443)
| spath
| stats count by Source_ip
| sort - count
```

- `index="main"` → Points Splunk to the correct dataset.  
- `spath` → Ensures JSON fields are parsed for querying.  
- `action=teardown` → Sessions that were closed.
- `protocol=443 OR dest_port=443` → Narrows down to HTTPS traffic. 
- `Source_ip` → The origin of the session.

<p align="left">
  <img src="images/lab09-splunk-figure.04.png?raw=true&v=2" 
       alt="SIEM alert" 
       style="border: 2px solid #444; border-radius: 6px;" 
       width="1000"><br>
  <em>Figure 4:</em>
</p>

This screenshot illustrates a search that filters for `action=teardown` and protocol `tcp` with ports 443 or destination port 443. Grouping by `Source_ip` reveals which IPs are generating SSL/TLS session terminations. This is useful for monitoring secure traffic patterns, diagnosing abnormal HTTPS teardown activity, or spotting potential misuse of encrypted connections.

High teardown frequency may indicate unstable tunnels, aggressive scanning behavior, or abnormal encrypted traffic flows.

**Good for**  

- Identifying terminated HTTPS sessions (potential exfiltration or scanning).
- Correlating which IPs are repeatedly generating teardown events.

---

### Phase 6 — Baseline Session Outcomes

**Objective:** Determine distribution of session outcomes across the dataset.
 
The distribution of session outcomes (e.g., `teardown`, `accept):

```spl
index="main"
| spath
| stats count by action
| sort - count
```

- `index="main"` → Points Splunk to the correct dataset.  
- `spath` → Ensures JSON fields are parsed for querying.   
- `action` → The outcome of a session (accepted, failed, teardown, etc.).
- `stats count by action` → Quickly counts how many of each outcome exist.

<p align="left">
  <img src="images/lab09-splunk-figure.05.png?raw=true&v=2" 
       alt="SIEM alert" 
       style="border: 2px solid #444; border-radius: 6px;" 
       width="1000"><br>
  <em>Figure 5</em>
</p>

This screenshot shows a baseline aggregation query using stats count by `Source_ip`, with results sorted in descending order. It highlights the top IP addresses generating events in the dataset. This is useful for quickly spotting “noisy” IPs, scanning activity, or establishing a baseline of top talkers in the environment.

This provides high-level insight into how frequently sessions are accepted, failed, or terminated, which can guide alert thresholds.

**Good for**  

- Establishing a baseline of normal network activity.
- Identifying spikes in unusual outcomes (e.g., too many `failed` events).

---

## Results & Interpretation
The aggregated queries demonstrate that meaningful security insights can be derived from VPN telemetry when logs are properly parsed and structured. By grouping events across users, IP addresses, and geographic regions, analysts can quickly identify outliers that warrant deeper investigation.

Failed authentication clustering suggests potential brute-force attempts, while geographic anomalies may indicate credential misuse or account sharing. Session teardown analysis provides visibility into encrypted session behavior that may correlate with network instability or misuse of VPN infrastructure.

---

## Operational & Defensive Takeaways
- VPN authentication logs should be routinely monitored for geographic anomalies.
- Repeated failures from the same source IP warrant automated alerting.
- Baseline activity by region and protocol supports anomaly detection tuning.
- JSON field extraction should be validated during onboarding of new data sources.

## Reuse Pack (Quick Reference)
Common pivots demonstrated in this workflow:
- Failed authentication aggregation:
```spl
index="main" action=failed | spath | stats count by UserName, Source_ip
```
- Country-based anomaly detection:
```spl
index="main" | spath | stats count by UserName, Source_Country
```
- Secure session teardown analysis:
```spl
index="main" action=teardown protocol=tcp (port=443 OR dest_port=443) | spath | stats count by Source_ip
```

---

## What I Learned (Skills Demonstrated)
This workflow reinforced how VPN telemetry can support detection of credential misuse and abnormal access behavior using simple aggregation techniques. It strengthened proficiency in JSON field extraction using `spath`, statistical summarization using `stats`, and investigative pivoting based on authentication outcomes and geographic distribution. These techniques directly support SOC triage workflows and can be operationalized into dashboards and alerts for continuous monitoring.