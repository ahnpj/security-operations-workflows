# VPN Authentication and Remote Access Anomaly Analysis Using Splunk

## Overview

This workflow documents practical anomaly detection analysis using Splunk to identify abnormal Business Process Name (BPN) activity within authentication and operational log telemetry. The workflow focuses on identifying deviations from expected process execution behavior by analyzing event frequency, process naming patterns, and usage trends across datasets.

The analysis progresses through structured detection phases that begin with establishing baseline process activity, followed by anomaly identification using statistical comparisons, filtering logic, and behavioral pattern analysis. The workflow demonstrates how monitoring process execution telemetry helps analysts detect suspicious activity such as unauthorized tooling, masquerading attempts, and abnormal execution frequency that may indicate compromise or misuse.

> **Workflow vs Execution vs Writeup (Terminology Used Here)**  
> - **Workflows** refer to operational tasks such as onboarding telemetry and validating parsing behavior.  
> - **Executions** refer to hands-on configuration and validation using real data and Splunk services.  
> - **Writeups** document configuration decisions, troubleshooting steps, and validation results.

> üëâ For a **detailed, step-by-step walkthrough of how this workflow was executed ‚Äî complete with screenshots**, see the **[Step-by-Step Execution Walkthrough](#step-by-step-execution)** section below.

---

### Purpose and Analyst Focus

#### ‚ñ∂ Purpose

The purpose of this workflow is to perform behavioral anomaly detection using Splunk by analyzing Business Process Name (BPN) activity within log telemetry. The workflow focuses on identifying process execution patterns that deviate from expected operational baselines and validating whether those anomalies represent legitimate business activity or potential security threats.

The workflow demonstrates how process telemetry supports detection engineering by enabling analysts to identify unusual process execution behavior, detect unauthorized tooling usage, and highlight indicators that may suggest persistence, lateral movement, or attacker-controlled execution. It emphasizes how statistical comparison and baseline validation improve detection reliability and reduce false positives in monitoring pipelines.

#### ‚ñ∂ Analyst Focus

The analyst focus is on using Splunk to analyze process execution telemetry, establish baseline behavior, identify anomalous BPN activity, and validate whether observed anomalies represent legitimate or suspicious operational behavior. The workflow reflects responsibilities commonly performed by SOC analysts and threat detection teams when investigating abnormal process execution patterns.

The workflow reinforces how analysts evaluate execution frequency, compare process activity across time ranges, identify outlier behaviors, and validate suspicious findings using contextual telemetry. It highlights the importance of understanding baseline system behavior, anomaly detection methodology, and investigative correlation when identifying potential security threats through behavioral monitoring.
This workflow is scoped to authentication and session-level telemetry generated by VPN infrastructure. The objective is not to perform attribution or endpoint validation, but to determine whether access patterns themselves indicate potential misuse, compromised credentials, or unstable connections requiring further investigation.

Key objectives include:
- Establishing baseline activity by user, geography, and session outcome
- Identifying accounts with repeated authentication failures
- Highlighting source IP addresses associated with frequent session teardowns
- Demonstrating how JSON fields are extracted and aggregated using SPL

---

## Environment and Execution Context

All analysis was performed within a controlled training environment using simulated VPN log data designed to reflect common remote access telemetry collected by security teams. Events were ingested into Splunk under a single logical index and stored in JSON format, requiring explicit field extraction prior to aggregation.

**Note:** Each section is collapsible. Click the ‚ñ∂ arrow to expand and view details on software, tools, environment, data sources, and more.

<details>
<summary><strong>‚ñ∂ Environment & Platform</strong><br>
</summary><br>
- Splunk Enterprise
- SPL (Search Processing Language)
- JSON field extraction using `spath`
</details>

<details>
<summary><strong>‚ñ∂ Data Sources Analyzed</strong><br>
</summary><br>
- VPN authentication and session events
- Fields of interest included:
  - `UserName`
  - `Source_ip`
  - `Source_Country`
  - `source_state`
  - `protocol`
  - `port` / `dest_port`
  - `action`
</details>

<details>
<summary><strong>‚ñ∂ Workflow Map (High-Level)</strong><br>
</summary><br>
1. Validate that VPN events are searchable and fields are extractable from JSON
2. Aggregate events by geography and user to establish access baselines
3. Isolate failed authentication attempts and identify potential brute-force patterns
4. Analyze session termination behavior over secure transport protocols
5. Review session outcome distributions to identify abnormal trends
</details>

---

### Step-by-Step Execution

This section documents the workflow in the same order an analyst would realistically perform behavioral anomaly detection using Splunk. The process begins by establishing baseline Business Process Name (BPN) activity to understand normal execution behavior across systems and users. Analysis then progresses into identifying deviations from expected patterns using frequency analysis, statistical comparisons, and targeted filtering logic.

Each step captures both the technical actions performed using SPL queries and the analytical reasoning behind those actions. The workflow intentionally progresses from baseline establishment into anomaly detection and validation, mirroring how analysts identify suspicious process behavior and confirm detection findings during threat-hunting and monitoring operations.

**Note:** Each section is collapsible. Click the ‚ñ∂ arrow to expand and view the detailed steps.

<details>
<summary><strong>‚ñ∂ Phase 1 ‚Äî Validate JSON Field Extraction and Dataset Scope</strong><br>
‚Üí ensuring VPN logs are accessible and structured fields can be queried
</summary><br>

**Goal:** Ensure VPN logs are accessible and structured fields can be queried.

##### üî∑ Phase 1.1 ‚Äî Run a broad search against the dataset to confirm events are indexed.

```spl
index="main"
```

##### üî∑ Phase 1.2 ‚Äî Apply `spath` to extract JSON fields for use in subsequent aggregations.
```spl
index="main"
| spath
```

This confirms that nested fields such as `UserName`, `Source_Country`, and `action` are available for aggregation and filtering.

</details>

<details>
<summary><strong>‚ñ∂ Phase 2 ‚Äî Analyze Activity by User and Country</strong><br>
‚Üí identifying accounts generating VPN sessions across multiple geographic regions
</summary><br>

**Goal:** Identify accounts generating VPN sessions across multiple geographic regions.

Events grouped by `UserName` and `Source_Country`, showing the number of times a user generated traffic from different countries:  

```spl
index="main" 
| spath 
| search Source_Country!="France" 
| stats count by UserName, Source_Country 
| sort - count
```

- `index="main"` ‚Üí Points Splunk to the correct dataset.  
- `spath` ‚Üí Ensures JSON fields are parsed for querying.  
- `UserName` ‚Üí Identifies the account.  
- `Source_Country` ‚Üí Captures geolocation metadata.  
- `stats count` ‚Üí Aggregates how many events match.  
- `sort - count` ‚Üí Displays most frequent results at the top.  

<p align="left">
  <img src="images/splunk-figure.01.png?raw=true&v=2" 
       alt="SIEM alert" 
       style="border: 2px solid #444; border-radius: 6px;" 
       width="1000"><br>
  <em>Figure 1</em>
</p>

This screenshot shows a Splunk query grouping events by `UserName` and `Source_Country`, excluding traffic from France. The results highlight geolocation activity, allowing detection of unusual login patterns such as a single user appearing in multiple foreign countries. Useful for identifying account compromise or suspicious travel-related anomalies

**Good for:**  

- Detecting unusual geolocation behavior (e.g., a user logging in from multiple foreign countries).  
- Identifying potential account compromise or travel-related anomalies.  

</details>

<details>
<summary><strong>‚ñ∂ Phase 3 ‚Äî Identify Failed Authentication Attempts</strong><br>
‚Üí surfacing potential brute-force or credential misuse patterns
</summary><br>

**Goal:** Surface potential brute-force or credential misuse patterns.

Events where `action=failed`, aggregated by user and IP:

```spl
index="main" action=failed
| spath
| stats count by UserName, Source_ip
| sort - count
```

- `index="main"` ‚Üí Points Splunk to the correct dataset.  
- `spath` ‚Üí Ensures JSON fields are parsed for querying.  
- `UserName` ‚Üí Identifies the account.  
- `action=failed` ‚Üí Filters only failed authentication attempts. 
- `UserName` ‚Üí Reveals which account is being targeted.  
- `Source_ip` ‚Üí Identifies the attacker or misconfigured client.

<p align="left">
  <img src="images/splunk-figure.02.png?raw=true&v=2" 
       alt="SIEM alert" 
       style="border: 2px solid #444; border-radius: 6px;" 
       width="1000"><br>
  <em>Figure 2</em>
</p>

This screenshot displays a Splunk search filtered for events where `action=failed`. Events are aggregated by `UserName` and `ource_ip`, making it possible to identify repeated login failures tied to specific accounts and source IPs. This is a common use case for detecting brute-force attempts or credential stuffing.

Repeated failures from the same IP against the same account can indicate automated attack attempts or misconfigured clients.

**Good for**  

- Investigating brute force attempts or repeated login failures. 
- Correlating failed attempts with possible attacker IP addresses.  

</details>

<details>
<summary><strong>‚ñ∂ Phase 4 ‚Äî Analyze Geographic Distribution Within a Single Country</strong><br>
‚Üí establishing baseline regional activity patterns
</summary><br>

**Goal:** Establish baseline regional activity patterns.

Events originating only from the `United States`, grouped by `source_state:

```spl
index="main" Source_Country="United States"
| spath
| stats count by source_state
| sort - count
```

- `index="main"` ‚Üí Points Splunk to the correct dataset.  
- `spath` ‚Üí Ensures JSON fields are parsed for querying.  
- `Source_Country="United States"` ‚Üí Filters for U.S. traffic only.  
- `source_state` ‚Üí Provides geographic detail within the country. 
- `stats count` ‚Üí Counts activity per state.

<p align="left">
  <img src="images/splunk-figure.03.png?raw=true&v=2" 
       alt="SIEM alert" 
       style="border: 2px solid #444; border-radius: 6px;" 
       width="1000"><br>
  <em>Figure 3</em>
</p>

This screenshot highlights a Splunk query filtered to `Source_Country="United States"`, with results grouped by `source_state`. The output provides insight into geographic distribution of traffic across U.S. states. This is helpful for baseline monitoring and identifying anomalies (e.g., a user accessing from a state that is outside expected regions).

Unexpected state-level access patterns may indicate account sharing, travel, or compromised VPN credentials.

**Good for**  

- Spotting regional anomalies within the same country.
- Useful for organizations that expect traffic only from certain states.  

</details>

<details>
<summary><strong>‚ñ∂ Phase 5 ‚Äî Analyze Secure Session Terminations</strong><br>
‚Üí identifying IPs frequently terminating encrypted VPN sessions
</summary><br>

**Goal:** Identify IPs frequently terminating encrypted VPN sessions.

Events where action is `teardown`, using `protocol=tcp`, focusing on `port=443` or any destination port equal to 443:


```spl
index="main" action=teardown protocol=tcp (port=443 OR dest_port=443)
| spath
| stats count by Source_ip
| sort - count
```

- `index="main"` ‚Üí Points Splunk to the correct dataset.  
- `spath` ‚Üí Ensures JSON fields are parsed for querying.  
- `action=teardown` ‚Üí Sessions that were closed.
- `protocol=443 OR dest_port=443` ‚Üí Narrows down to HTTPS traffic. 
- `Source_ip` ‚Üí The origin of the session.

<p align="left">
  <img src="images/splunk-figure.04.png?raw=true&v=2" 
       alt="SIEM alert" 
       style="border: 2px solid #444; border-radius: 6px;" 
       width="1000"><br>
  <em>Figure 4:</em>
</p>

This screenshot illustrates a search that filters for `action=teardown` and protocol `tcp` with ports 443 or destination port 443. Grouping by `Source_ip` reveals which IPs are generating SSL/TLS session terminations. This is useful for monitoring secure traffic patterns, diagnosing abnormal HTTPS teardown activity, or spotting potential misuse of encrypted connections.

High teardown frequency may indicate unstable tunnels, aggressive scanning behavior, or abnormal encrypted traffic flows.

**Good for**  

- Identifying terminated HTTPS sessions (potential exfiltration or scanning).
- Correlating which IPs are repeatedly generating teardown events.

</details>

<details>
<summary><strong>‚ñ∂ Phase 6 ‚Äî Baseline Session Outcomes</strong><br>
‚Üí determining distribution of session outcomes across the dataset
</summary><br>

**Goal:** Determine distribution of session outcomes across the dataset.
 
The distribution of session outcomes (e.g., `teardown`, `accept):

```spl
index="main"
| spath
| stats count by action
| sort - count
```

- `index="main"` ‚Üí Points Splunk to the correct dataset.  
- `spath` ‚Üí Ensures JSON fields are parsed for querying.   
- `action` ‚Üí The outcome of a session (accepted, failed, teardown, etc.).
- `stats count by action` ‚Üí Quickly counts how many of each outcome exist.

<p align="left">
  <img src="images/splunk-figure.05.png?raw=true&v=2" 
       alt="SIEM alert" 
       style="border: 2px solid #444; border-radius: 6px;" 
       width="1000"><br>
  <em>Figure 5</em>
</p>

This screenshot shows a baseline aggregation query using stats count by `Source_ip`, with results sorted in descending order. It highlights the top IP addresses generating events in the dataset. This is useful for quickly spotting ‚Äúnoisy‚Äù IPs, scanning activity, or establishing a baseline of top talkers in the environment.

This provides high-level insight into how frequently sessions are accepted, failed, or terminated, which can guide alert thresholds.

**Good for**  

- Establishing a baseline of normal network activity.
- Identifying spikes in unusual outcomes (e.g., too many `failed` events).

</details>

---

### Results & Interpretation
The aggregated queries demonstrate that meaningful security insights can be derived from VPN telemetry when logs are properly parsed and structured. By grouping events across users, IP addresses, and geographic regions, analysts can quickly identify outliers that warrant deeper investigation.

Failed authentication clustering suggests potential brute-force attempts, while geographic anomalies may indicate credential misuse or account sharing. Session teardown analysis provides visibility into encrypted session behavior that may correlate with network instability or misuse of VPN infrastructure.

---

### Operational & Defensive Takeaways
- VPN authentication logs should be routinely monitored for geographic anomalies.
- Repeated failures from the same source IP warrant automated alerting.
- Baseline activity by region and protocol supports anomaly detection tuning.
- JSON field extraction should be validated during onboarding of new data sources.

---

### Reuse Pack (Quick Reference)

Common pivots demonstrated in this workflow:
- Failed authentication aggregation:
```spl
index="main" action=failed | spath | stats count by UserName, Source_ip
```
- Country-based anomaly detection:
```spl
index="main" | spath | stats count by UserName, Source_Country
```
- Secure session teardown analysis:
```spl
index="main" action=teardown protocol=tcp (port=443 OR dest_port=443) | spath | stats count by Source_ip
```

---

## What I Learned (Skills Demonstrated)

This workflow reinforced how VPN telemetry can support detection of credential misuse and abnormal access behavior using simple aggregation techniques. It strengthened proficiency in JSON field extraction using `spath`, statistical summarization using `stats`, and investigative pivoting based on authentication outcomes and geographic distribution. These techniques directly support SOC triage workflows and can be operationalized into dashboards and alerts for continuous monitoring.

